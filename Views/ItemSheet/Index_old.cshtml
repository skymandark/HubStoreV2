@{
    ViewData["Title"] = "كشف حركة صنف";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-file-alt"></i>
                كشف حركة صنف
            </h5>
        </div>
        <div class="card-body">
            <form id="searchForm">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="itemSearch">الصنف</label>
                            <div class="input-group">
                                <input type="text" id="itemSearch" class="form-control" placeholder="ابحث عن صنف...">
                                <input type="hidden" id="itemId" name="itemId" required>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" id="clearItem">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted">يمكن البحث بالكود أو اسم الصنف</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="branchSearch">المخزن</label>
                            <div class="input-group">
                                <input type="text" id="branchSearch" class="form-control" placeholder="ابحث عن مخزن...">
                                <input type="hidden" id="branchId" name="branchId" required>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" id="clearBranch">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted">يمكن البحث بالكود أو اسم المخزن</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="fromDate">من تاريخ</label>
                            <input type="date" id="fromDate" name="fromDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="toDate">إلى تاريخ</label>
                            <input type="date" id="toDate" name="toDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="btn-group w-100">
                                <button type="button" id="searchBtn" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                    بحث
                                </button>
                                <button type="button" id="printBtn" class="btn btn-success" disabled>
                                    <i class="fas fa-print"></i>
                                    طباعة
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <div id="summaryInfo" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                    <h6>معلومات التقرير</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>الصنف:</strong> <span id="summaryItem"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>المخزن:</strong> <span id="summaryBranch"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>الرصيد الافتتاحي:</strong> <span id="summaryOpeningBalance"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>الرصيد النهائي:</strong> <span id="summaryClosingBalance"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-3" id="resultsCard" style="display: none;">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="fas fa-list"></i>
                تفاصيل الحركات
            </h6>
        </div>
        <div class="card-body">
            <div id="transactionsGrid"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Set default dates
            var today = new Date();
            var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            $('#fromDate').val(firstDay.toISOString().split('T')[0]);
            $('#toDate').val(today.toISOString().split('T')[0]);

            // Initialize autocomplete for items
            $('#itemSearch').autocomplete({
                source: function(request, response) {
                    $.get('/ItemSheet/GetItemName', { term: request.term }, function(data) {
                        response($.map(data, function(item) {
                            return {
                                label: item.itemCode + ' - ' + item.itemName,
                                value: item.itemName,
                                id: item.itemId,
                                code: item.itemCode
                            };
                        }));
                    });
                },
                select: function(event, ui) {
                    $('#itemId').val(ui.item.id);
                    $('#itemSearch').val(ui.item.label);
                    return false;
                },
                minLength: 2
            });

            // Initialize autocomplete for branches
            $('#branchSearch').autocomplete({
                source: function(request, response) {
                    $.get('/ItemSheet/GetBranchName', { term: request.term }, function(data) {
                        response($.map(data, function(branch) {
                            return {
                                label: branch.branchCode + ' - ' + branch.name,
                                value: branch.name,
                                id: branch.branchId,
                                code: branch.branchCode
                            };
                        }));
                    });
                },
                select: function(event, ui) {
                    $('#branchId').val(ui.item.id);
                    $('#branchSearch').val(ui.item.label);
                    return false;
                },
                minLength: 2
            });

            // Clear buttons
            $('#clearItem').click(function() {
                $('#itemSearch').val('');
                $('#itemId').val('');
            });

            $('#clearBranch').click(function() {
                $('#branchSearch').val('');
                $('#branchId').val('');
            });

            // Search button
            $('#searchBtn').click(function() {
                if (!$('#searchForm')[0].checkValidity()) {
                    $('#searchForm')[0].reportValidity();
                    return;
                }

                var itemId = $('#itemId').val();
                var branchId = $('#branchId').val();
                var fromDate = $('#fromDate').val();
                var toDate = $('#toDate').val();

                // Get opening balance
                $.get('/ItemSheet/GetItemOpenBalance', {
                    itemId: itemId,
                    branchId: branchId,
                    fromDate: fromDate
                }, function(data) {
                    if (data.success) {
                        $('#summaryOpeningBalance').text(data.data.toFixed(2));
                    }
                });

                // Update summary info
                $('#summaryItem').text($('#itemSearch').val());
                $('#summaryBranch').text($('#branchSearch').val());
                $('#summaryInfo').show();

                // Load transactions
                loadTransactions();
            });

            // Print button
            $('#printBtn').click(function() {
                var itemId = $('#itemId').val();
                var branchId = $('#branchId').val();
                var fromDate = $('#fromDate').val();
                var toDate = $('#toDate').val();

                var url = '/ItemSheet/Details?itemId=' + itemId + '&branchId=' + branchId + 
                         '&fromDate=' + fromDate + '&toDate=' + toDate;
                window.open(url, '_blank');
            });

            function loadTransactions() {
                var itemId = $('#itemId').val();
                var branchId = $('#branchId').val();
                var fromDate = $('#fromDate').val();
                var toDate = $('#toDate').val();

                $.get('/ItemSheet/GetTransactions', {
                    itemId: itemId,
                    branchId: branchId,
                    fromDate: fromDate,
                    toDate: toDate
                }, function(data) {
                    if (data.success) {
                        $('#transactionsGrid').dxDataGrid({
                            dataSource: data.data,
                            columns: [
                                { dataField: 'docDate', caption: 'التاريخ', dataType: 'date', format: 'yyyy-MM-dd' },
                                { dataField: 'transactionType', caption: 'نوع الحركة' },
                                { dataField: 'baseId', caption: 'رقم الحركة' },
                                { dataField: 'remarks', caption: 'البيان' },
                                { 
                                    dataField: 'inQuantity', 
                                    caption: 'كمية واردة',
                                    format: { type: 'fixedPoint', precision: 2 },
                                    cellTemplate: function(container, options) {
                                        if (options.value && options.value > 0) {
                                            container.text(options.value.toFixed(2));
                                        }
                                    }
                                },
                                { 
                                    dataField: 'outQuantity', 
                                    caption: 'كمية منصرفة',
                                    format: { type: 'fixedPoint', precision: 2 },
                                    cellTemplate: function(container, options) {
                                        if (options.value && options.value > 0) {
                                            container.text(options.value.toFixed(2));
                                        }
                                    }
                                },
                                { 
                                    dataField: 'balance', 
                                    caption: 'الرصيد',
                                    format: { type: 'fixedPoint', precision: 2 }
                                },
                                { dataField: 'price', caption: 'السعر', format: { type: 'fixedPoint', precision: 2 } },
                                { dataField: 'itemPackageName', caption: 'الوحدة' },
                                { dataField: 'userData', caption: 'المستخدم' },
                                { dataField: 'entryDate', caption: 'تاريخ الإدخال', dataType: 'date', format: 'yyyy-MM-dd HH:mm' }
                            ],
                            paging: {
                                pageSize: 15
                            },
                            pager: {
                                showPageSizeSelector: true,
                                allowedPageSizes: [10, 15, 25, 50]
                            },
                            showRowLines: true,
                            showBorders: true,
                            filterRow: {
                                visible: true,
                                applyFilter: 'auto'
                            },
                            headerFilter: {
                                visible: true
                            },
                            columnAutoWidth: true,
                            height: 500,
                            onContentReady: function(e) {
                                $('#summaryClosingBalance').text(
                                    data.data.length > 0 ? 
                                    data.data[data.data.length - 1].balance.toFixed(2) : 
                                    '0.00'
                                );
                            }
                        });

                        $('#resultsCard').show();
                        $('#printBtn').prop('disabled', false);
                    } else {
                        alert('حدث خطأ: ' + data.message);
                    }
                });
            }
        });
    </script>
}

<style>
    .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
    }
</style>
