@model Core.ViewModels.StockInViewModels.StockInRequestDto
@{
    ViewData["Title"] = "إنشاء إذن استلام";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    :root {
        --primary-solid: #1e293b;
        --secondary-solid: #64748b;
        --accent-solid: #334155;
        --bg-soft: #f8fafc;
        --border-soft: #e2e8f0;
    }

    .card-elegant {
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        background: #fff;
    }

    .form-header-elegant {
        background-color: var(--primary-solid);
        color: white;
        padding: 30px 40px;
        border-radius: 12px 12px 0 0;
    }

    .grid-container-elegant {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--border-soft);
    }

    .summary-box-elegant {
        background: var(--bg-soft);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid var(--border-soft);
    }

    .btn-elegant-primary {
        background-color: #fff;
        color: var(--primary-solid);
        border: none;
        padding: 10px 30px;
        font-weight: 700;
        transition: all 0.2s;
    }

    .btn-elegant-primary:hover {
        background-color: #f1f5f9;
        transform: translateY(-1px);
        color: var(--primary-solid);
    }

    .btn-elegant-outline {
        border: 1.5px solid rgba(255,255,255,0.3);
        color: white;
        transition: all 0.2s;
    }

    .btn-elegant-outline:hover {
        background-color: rgba(255,255,255,0.1);
        border-color: #fff;
        color: white;
    }
</style>

<div class="container-fluid py-4 animate__animated animate__fadeIn">
    <form asp-action="Create" method="post" id="stockInForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="PurchaseOrderId" id="PurchaseOrderId" value="@Model.PurchaseOrderId" />

        <div class="card card-elegant border-0">
            <div class="form-header-elegant d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-file-invoice me-3"></i> إنشاء إذن استلام</h1>
                    <p>استلام بضائع بناءً على أمر شراء أو استلام حر</p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" id="btnSelectPO" class="btn btn-elegant-outline px-4 rounded-pill">
                        <i class="fas fa-search me-2"></i> اختيار أمر شراء
                    </button>
                    <a href="@Url.Action("Index")" class="btn btn-elegant-outline px-4 rounded-pill">إلغاء</a>
                    <button type="submit" class="btn btn-elegant-primary px-5 rounded-pill shadow">حفظ الإذن</button>
                </div>
            </div>

            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-lg-12">
                        <div id="headerForm"></div>
                    </div>

                    <div class="col-lg-12 mt-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-slate-100 p-2 rounded-3 me-3">
                                <i class="fas fa-list-ul text-slate-600"></i>
                            </div>
                            <h5 class="fw-bold text-dark mb-0">أصناف الاستلام</h5>
                        </div>
                        <div id="itemsGrid" class="grid-container-elegant shadow-sm"></div>
                    </div>

                    <div class="col-lg-12 mt-4">
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <div id="remarksForm"></div>
                            </div>
                            <div class="col-lg-4">
                                <div class="summary-box-elegant h-100 d-flex flex-column justify-content-center">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="text-muted fw-bold">إجمالي القيمة</span>
                                        <span id="grandTotalDisplay" class="fs-3 fw-bold text-dark">0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                                        <span>عدد الأصناف</span>
                                        <span id="itemCountDisplay" class="badge bg-white text-dark border px-3 py-2 fw-bold">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- PO Selection Modal -->
<div id="poPopup"></div>

@section Scripts {
    <script>
        $(function() {
            const suppliers = @Html.Raw(Json.Serialize(Model.Suppliers));
            const branches = @Html.Raw(Json.Serialize(Model.Branches));
            const itemsLookup = @Html.Raw(Json.Serialize(Model.Items));
            const initialDetails = @Html.Raw(Json.Serialize(Model.StockInDetails));

            const headerForm = $("#headerForm").dxForm({
                rtlEnabled: true,
                colCount: 3,
                formData: {
                    DocDate: new Date("@Model.DocDate.ToString("yyyy-MM-dd")"),
                    BranchId: @(Model.BranchId > 0 ? Model.BranchId : "null"),
                    SupplierId: @(Model.SupplierId > 0 ? Model.SupplierId : "null"),
                    InvoiceNo: "@Model.InvoiceNo",
                    TransactionTypeId: @Model.TransactionTypeId
                },
                items: [
                    {
                        dataField: "DocDate",
                        label: { text: "تاريخ الاستلام" },
                        editorType: "dxDateBox",
                        editorOptions: { width: "100%", stylingMode: "outlined" },
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "BranchId",
                        label: { text: "الفرع" },
                        editorType: "dxSelectBox",
                        editorOptions: {
                            dataSource: branches,
                            displayExpr: "name",
                            valueExpr: "branchId",
                            stylingMode: "outlined",
                            searchEnabled: true
                        },
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "SupplierId",
                        label: { text: "المورد" },
                        editorType: "dxSelectBox",
                        editorOptions: {
                            dataSource: suppliers,
                            displayExpr: "name",
                            valueExpr: "supplierId",
                            stylingMode: "outlined",
                            searchEnabled: true
                        },
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "InvoiceNo",
                        label: { text: "رقم الفاتورة" },
                        editorType: "dxTextBox",
                        editorOptions: { stylingMode: "outlined" }
                    }
                ]
            }).dxForm("instance");

            const itemsGrid = $("#itemsGrid").dxDataGrid({
                dataSource: initialDetails || [],
                rtlEnabled: true,
                showBorders: false,
                columnAutoWidth: true,
                editing: {
                    mode: "cell",
                    allowAdding: true,
                    allowUpdating: true,
                    allowDeleting: true,
                    useIcons: true
                },
                columns: [
                    {
                        dataField: "itemId",
                        caption: "الصنف",
                        width: 200,
                        lookup: {
                            dataSource: itemsLookup,
                            displayExpr: "name",
                            valueExpr: "itemId"
                        }
                    },
                    { dataField: "availableStock", caption: "الرصيد", dataType: "number", allowEditing: false, 
                      width: 100, alignment: "center", cssClass: "text-muted fw-bold" },
                    {
                        dataField: "qty",
                        caption: "الكمية",
                        dataType: "number",
                        width: 100,
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "price",
                        caption: "السعر",
                        dataType: "number",
                        format: "#,##0.00",
                        width: 120
                    },
                    {
                        dataField: "totalValue",
                        caption: "الإجمالي",
                        allowEditing: false,
                        calculateCellValue: function(rowData) {
                            return (rowData.qty || 0) * (rowData.price || 0);
                        },
                        format: "#,##0.00",
                        cssClass: "fw-bold"
                    },
                    { dataField: "expiryDate", caption: "تاريخ الصلاحية", dataType: "date", width: 120 }
                ],
                onRowInserted: () => calculateTotals(),
                onRowUpdated: () => calculateTotals(),
                onRowRemoved: () => calculateTotals(),
                onContentReady: () => calculateTotals(),
                onCellValueChanged: function(e) {
                    if (e.column.dataField === "itemId") {
                        var branchId = headerForm.option("formData").BranchId;
                        if (e.data.itemId && branchId) {
                            $.post("@Url.Action("GetItemBalance", "Item")", { itemId: e.data.itemId, branchId: branchId }, function(res) {
                                e.component.cellValue(e.row.rowIndex, "availableStock", res.balance);
                            });
                        }
                    }
                }
            }).dxDataGrid("instance");

            $("#remarksForm").dxForm({
                rtlEnabled: true,
                formData: { Remarks: "@Model.Remarks" },
                items: [{
                    dataField: "Remarks",
                    label: { text: "ملاحظات" },
                    editorType: "dxTextArea",
                    editorOptions: { height: 80, stylingMode: "outlined" }
                }]
            });

            function calculateTotals() {
                const data = itemsGrid.option("dataSource") || [];
                let total = 0;
                data.forEach(item => {
                    total += (item.qty || 0) * (item.price || 0);
                });
                $("#grandTotalDisplay").text(total.toLocaleString(undefined, { minimumFractionDigits: 2 }));
                $("#itemCountDisplay").text(data.length);
            }

            // PO Selection Logic
            const popup = $("#poPopup").dxPopup({
                title: "اختيار أمر شراء",
                width: 800,
                height: 500,
                contentTemplate: function(contentElement) {
                    $("<div id='poGrid'>").appendTo(contentElement).dxDataGrid({
                        dataSource: {
                            load: () => $.getJSON("@Url.Action("GetPurchaseOrders")")
                        },
                        rtlEnabled: true,
                        columns: [
                            { dataField: "purchaseOrderCode", caption: "رقم الأمر" },
                            { dataField: "supplierName", caption: "المورد" },
                            { dataField: "docDate", caption: "التاريخ", dataType: "date" },
                            { 
                                type: "buttons", 
                                buttons: [{
                                    text: "اختيار",
                                    onClick: function(e) {
                                        selectPO(e.row.data.purchaseOrderId);
                                        popup.hide();
                                    }
                                }]
                            }
                        ]
                    });
                }
            }).dxPopup("instance");

            $("#btnSelectPO").click(() => popup.show());

            function selectPO(poId) {
                $.getJSON(`@Url.Action("GetPurchaseOrderDetails")?purchaseOrderId=${poId}`, function(response) {
                    if (response.success) {
                        $("#PurchaseOrderId").val(response.po.purchaseOrderId);
                        
                        // Set header from PO
                        headerForm.updateData({
                            SupplierId: suppliers.find(s => s.name === response.po.supplierName)?.supplierId,
                            // Branch is usually in the PO too
                        });

                        // Set grid items
                        const newItems = response.items.map(i => ({
                            itemId: i.itemId,
                            qty: i.remainingQty,
                            price: i.price,
                            purchaseOrderDetailId: i.purchaseOrderDetailId
                        }));
                        itemsGrid.option("dataSource", newItems);
                    }
                });
            }

            $("#stockInForm").on("submit", function(e) {
                const headerData = headerForm.option("formData");
                const gridData = itemsGrid.option("dataSource");

                if (!gridData || gridData.length === 0) {
                    DevExpress.ui.notify("يرجى إضافة صنف واحد على الأقل", "error");
                    return false;
                }

                // Append header data
                for (const key in headerData) {
                    const val = headerData[key] instanceof Date ? headerData[key].toISOString() : headerData[key];
                    $("<input>").attr("type", "hidden").attr("name", key).val(val).appendTo(this);
                }

                // Append remarks
                const remarksData = $("#remarksForm").dxForm("instance").option("formData");
                $("<input>").attr("type", "hidden").attr("name", "Remarks").val(remarksData.Remarks).appendTo(this);

                // Append items
                gridData.forEach((item, i) => {
                    for (const prop in item) {
                        let val = item[prop];
                        if (val instanceof Date) val = val.toISOString();
                        $("<input>").attr("type", "hidden").attr("name", `StockInDetails[${i}].${prop}`).val(val).appendTo(this);
                    }
                });

                return true;
            });
        });
    </script>
}
