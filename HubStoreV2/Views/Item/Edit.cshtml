@model Core.ViewModels.ItemViewModels.UpdateItemViewModel
@{
    ViewData["Title"] = "تعديل بيانات الصنف";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    :root {
        --primary-solid: #1e293b;
        --secondary-solid: #64748b;
        --accent-solid: #3b82f6;
        --bg-soft: #f8fafc;
        --border-soft: #e2e8f0;
    }

    .card-elegant {
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        background: #fff;
    }

    .form-header-elegant {
        background-color: var(--primary-solid);
        color: white;
        padding: 30px 40px;
        border-radius: 12px 12px 0 0;
    }

    .btn-elegant-primary {
        background-color: var(--accent-solid);
        color: white;
        border: none;
        padding: 10px 30px;
        font-weight: 600;
        transition: all 0.2s;
        border-radius: 50px;
    }

    .btn-elegant-primary:hover {
        background-color: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        color: white;
    }

    .btn-elegant-outline {
        border: 1.5px solid rgba(255,255,255,0.3);
        color: white;
        transition: all 0.2s;
        border-radius: 50px;
    }

    .btn-elegant-outline:hover {
        background-color: rgba(255,255,255,0.1);
        border-color: #fff;
        color: white;
    }

    .dx-form-group-caption { font-weight: 700 !important; color: var(--primary-solid) !important; }
</style>

<div class="container-fluid py-4 animate__animated animate__fadeIn">
    <form asp-action="Edit" method="post" id="itemForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@ViewBag.ItemId" />

        <div class="card card-elegant border-0">
            <div class="form-header-elegant d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-edit me-2"></i> تعديل الصنف: @ViewBag.ItemCode</h1>
                    <p class="mb-0 opacity-75">تعديل البيانات الأساسية وحالة الصنف الحالي</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="@Url.Action("Index")" class="btn btn-elegant-outline px-4">إلغاء</a>
                    <button type="submit" class="btn btn-elegant-primary px-5 shadow">تحديث البيانات</button>
                </div>
            </div>

            <div class="card-body p-4">
                <div id="formContainer"></div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        $(function() {
            const sections = @Html.Raw(Json.Serialize(ViewBag.Sections));
            const mainItems = @Html.Raw(Json.Serialize(ViewBag.MainItems));
            const subItems = @Html.Raw(Json.Serialize(ViewBag.SubItems));
            const brands = @Html.Raw(Json.Serialize(ViewBag.Brands));
            const itemTypes = @Html.Raw(Json.Serialize(ViewBag.ItemTypes));
            const packages = @Html.Raw(Json.Serialize(ViewBag.Packages));

            $("#formContainer").dxForm({
                formData: @Html.Raw(Json.Serialize(Model)),
                rtlEnabled: true,
                colCount: 2,
                labelMode: "floating",
                onInitialized: function(e) {
                    // Initialize dependent dropdowns if values exist
                    const formData = e.component.option("formData");
                    if (formData.SectionId) {
                        const filtered = mainItems.filter(m => m.sectionId === formData.SectionId);
                        e.component.getEditor("MainItemId").option("dataSource", filtered);
                    }
                    if (formData.MainItemId) {
                        const filtered = subItems.filter(s => s.mainItemId === formData.MainItemId);
                        e.component.getEditor("SubItemId").option("dataSource", filtered);
                    }
                },
                items: [
                    {
                        itemType: "group",
                        caption: "بيانات التعريف الأساسية",
                        items: [
                            { dataField: "NameArab", label: { text: "الاسم (بالعربي)" }, editorOptions: { stylingMode: "outlined" }, validationRules: [{ type: "required" }] },
                            { dataField: "NameEng", label: { text: "الاسم (English)" }, editorOptions: { stylingMode: "outlined" }, validationRules: [{ type: "required" }] },
                            { 
                                dataField: "ItemTypeId", 
                                label: { text: "نوع الصنف" }, 
                                editorType: "dxSelectBox",
                                editorOptions: { 
                                    dataSource: itemTypes, 
                                    displayExpr: "nameArab", 
                                    valueExpr: "itemTypeId",
                                    placeholder: "-- اختر نوع الصنف --",
                                    stylingMode: "outlined",
                                    searchEnabled: true
                                } 
                            },
                            { dataField: "IsActive", label: { text: "نشط", alignment: "right" }, editorType: "dxCheckBox" }
                        ]
                    },
                    {
                        itemType: "group",
                        caption: "التصنيف والهيكل",
                        items: [
                            { 
                                dataField: "SectionId", 
                                label: { text: "القسم" }, 
                                editorType: "dxSelectBox",
                                editorOptions: { 
                                    dataSource: sections, 
                                    displayExpr: "nameArab", 
                                    valueExpr: "sectionId",
                                    placeholder: "-- اختر القسم --",
                                    stylingMode: "outlined",
                                    searchEnabled: true,
                                    onValueChanged: function(e) {
                                        const mainItemEditor = $("#formContainer").dxForm("instance").getEditor("MainItemId");
                                        const filteredMainItems = mainItems.filter(m => m.sectionId === e.value);
                                        mainItemEditor.option("dataSource", filteredMainItems);
                                        mainItemEditor.option("value", null);
                                    }
                                },
                                validationRules: [{ type: "required" }]
                            },
                            { 
                                dataField: "MainItemId", 
                                label: { text: "القسم الرئيسي" }, 
                                editorType: "dxSelectBox",
                                editorOptions: { 
                                    dataSource: mainItems, // Initially allow all to support binding, but filtered by SectionId in onInitialized
                                    displayExpr: "nameArab", 
                                    valueExpr: "mainItemId",
                                    placeholder: "-- اختر القسم أولاً --",
                                    stylingMode: "outlined",
                                    searchEnabled: true,
                                    onValueChanged: function(e) {
                                        const subItemEditor = $("#formContainer").dxForm("instance").getEditor("SubItemId");
                                        const filteredSubItems = subItems.filter(s => s.mainItemId === e.value);
                                        subItemEditor.option("dataSource", filteredSubItems);
                                        subItemEditor.option("value", null);
                                    }
                                },
                                validationRules: [{ type: "required" }]
                            },
                            { 
                                dataField: "SubItemId", 
                                label: { text: "القسم الفرعي" }, 
                                editorType: "dxSelectBox",
                                editorOptions: { 
                                    dataSource: subItems, // Initially allow all to support binding
                                    displayExpr: "nameArab", 
                                    valueExpr: "subItemId",
                                    placeholder: "-- اختر القسم الرئيسي أولاً --",
                                    stylingMode: "outlined",
                                    searchEnabled: true
                                },
                                validationRules: [{ type: "required" }]
                            },
                            { 
                                dataField: "BrandId", 
                                label: { text: "المُصنّع" }, 
                                editorType: "dxSelectBox",
                                editorOptions: { 
                                    dataSource: brands, 
                                    displayExpr: "nameArab", 
                                    valueExpr: "brandId",
                                    placeholder: "-- اختر المُصنّع --",
                                    stylingMode: "outlined",
                                    searchEnabled: true
                                } 
                            }
                        ]
                    },
                    {
                        itemType: "group",
                        caption: "بيانات الشراء والباركود",
                        items: [
                            { 
                                dataField: "BuyMainPackageId", 
                                label: { text: "وحدة الشراء" }, 
                                editorType: "dxSelectBox",
                                editorOptions: { 
                                    dataSource: packages, 
                                    displayExpr: "nameArab", 
                                    valueExpr: "packageId",
                                    placeholder: "-- اختر وحدة الشراء --",
                                    stylingMode: "outlined",
                                    searchEnabled: true
                                },
                                validationRules: [{ type: "required" }]
                            },
                            { dataField: "PackageCount", label: { text: "العدد للوحدة" }, editorType: "dxNumberBox", editorOptions: { stylingMode: "outlined" } },
                            { dataField: "BuySubPackageCount", label: { text: "عدد العلب في الكرتونة" }, editorType: "dxNumberBox", editorOptions: { stylingMode: "outlined" } },
                            { dataField: "InternalBarcode", label: { text: "الباركود الداخلي" }, editorOptions: { stylingMode: "outlined" } },
                            { dataField: "ExternalBarcode", label: { text: "الباركود الخارجي" }, editorOptions: { stylingMode: "outlined" } }
                        ]
                    },
                    {
                        itemType: "group",
                        caption: "الوحدات والمحاذير",
                        items: [
                            { dataField: "MainUnitCode", label: { text: "الوحدة الكبرى (Code)" }, editorOptions: { stylingMode: "outlined" } },
                            { dataField: "BaseUnitCode", label: { text: "الوحدة الصغرى (Code)" }, editorOptions: { stylingMode: "outlined" } },
                            { dataField: "Notes", label: { text: "المحاذير / ملاحظات" }, editorType: "dxTextArea", editorOptions: { height: 80, stylingMode: "outlined" } }
                        ]
                    }
                ]
            });

            $("#itemForm").on("submit", function() {
                const formData = $("#formContainer").dxForm("instance").option("formData");
                for (let key in formData) {
                    if ($(`[name='${key}']`).length === 0) {
                        $("<input>").attr("type", "hidden").attr("name", key).val(formData[key]).appendTo("#itemForm");
                    }
                }
            });
        });
    </script>
}
