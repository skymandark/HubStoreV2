@{
    ViewData["Title"] = "إنشاء حساب جديد";
    Layout = null;
}

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - HubStore ERP</title>
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/23.2.5/css/dx.light.css" />
</head>
<body>
    <div style="padding: 50px; max-width: 500px; margin: 0 auto;">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2>إنشاء حساب جديد</h2>
            <p>انضم إلى نظام HubStore ERP</p>
        </div>

        <div id="registerForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <div>البريد الإلكتروني *</div>
                    <div id="emailTextBox"></div>
                </div>
                <div>
                    <div>اسم المستخدم</div>
                    <div id="userNameTextBox"></div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <div>كلمة المرور *</div>
                    <div id="passwordTextBox"></div>
                    <div id="passwordStrengthBar"></div>
                </div>
                <div>
                    <div>تأكيد كلمة المرور *</div>
                    <div id="confirmPasswordTextBox"></div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <div>رقم الهاتف</div>
                    <div id="phoneNumberTextBox"></div>
                </div>
                <div>
                    <div>رقم الموظف</div>
                    <div id="employeeIdNumberBox"></div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <div>رمز PIN</div>
                    <div id="pinCodeTextBox"></div>
                </div>
                <div>
                    <div>&nbsp;</div>
                    <div id="isAdminCheckbox"></div>
                </div>
            </div>

            <div id="registerButton"></div>
        </div>

        <div style="text-align: center; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
            <p>لديك حساب بالفعل؟ <a href="/Auth/LoginDX">تسجيل الدخول</a></p>
        </div>
    </div>

    <script src="https://cdn3.devexpress.com/jslib/23.2.5/js/dx.all.js"></script>
    <script>
        $(function() {
            // Initialize DevExtreme components
            initializeComponents();

            // Form submission
            $('#registerForm').on('submit', function(e) {
                e.preventDefault();
                register();
            });
        });

        function initializeComponents() {
            // Email TextBox with validation
            $("#emailTextBox").dxTextBox({
                placeholder: "example@domain.com",
                stylingMode: "outlined",
                showClearButton: true,
                onValueChanged: function(e) {
                    email = e.value;
                    validateEmail();
                }
            }).dxValidator({
                validationRules: [{
                    type: "required",
                    message: "البريد الإلكتروني مطلوب"
                }, {
                    type: "email",
                    message: "الرجاء إدخال بريد إلكتروني صحيح"
                }]
            });

            // Username TextBox
            $("#userNameTextBox").dxTextBox({
                placeholder: "اختر اسم مستخدم",
                stylingMode: "outlined",
                showClearButton: true,
                onValueChanged: function(e) {
                    userName = e.value;
                }
            });

            // Password TextBox
            $("#passwordTextBox").dxTextBox({
                placeholder: "أدخل كلمة المرور",
                mode: "password",
                stylingMode: "outlined",
                showClearButton: true,
                onValueChanged: function(e) {
                    password = e.value;
                    updatePasswordStrength(e.value);
                    validatePasswordMatch();
                }
            }).dxValidator({
                validationRules: [{
                    type: "required",
                    message: "كلمة المرور مطلوبة"
                }, {
                    type: "stringLength",
                    min: 6,
                    message: "كلمة المرور يجب أن تكون 6 أحرف على الأقل"
                }]
            });

            // Password Strength Bar
            $("#passwordStrengthBar").dxProgressBar({
                min: 0,
                max: 100,
                value: 0,
                statusFormat: function(value) {
                    if (value <= 33) return "ضعيفة";
                    if (value <= 66) return "متوسطة";
                    return "قوية";
                }
            });

            // Confirm Password TextBox
            $("#confirmPasswordTextBox").dxTextBox({
                placeholder: "أعد إدخال كلمة المرور",
                mode: "password",
                stylingMode: "outlined",
                showClearButton: true,
                onValueChanged: function(e) {
                    confirmPassword = e.value;
                    validatePasswordMatch();
                }
            }).dxValidator({
                validationRules: [{
                    type: "required",
                    message: "تأكيد كلمة المرور مطلوب"
                }, {
                    type: "compare",
                    comparisonTarget: function() {
                        return password;
                    },
                    comparisonType: "=",
                    message: "كلمات المرور غير متطابقة"
                }]
            });

            // Phone Number TextBox
            $("#phoneNumberTextBox").dxTextBox({
                placeholder: "05xxxxxxxx",
                stylingMode: "outlined",
                showClearButton: true,
                mask: "0000000000",
                onValueChanged: function(e) {
                    phoneNumber = e.value;
                }
            });

            // Employee ID NumberBox
            $("#employeeIdNumberBox").dxNumberBox({
                placeholder: "رقم الموظف (اختياري)",
                stylingMode: "outlined",
                showClearButton: true,
                format: "#",
                onValueChanged: function(e) {
                    employeeId = e.value;
                }
            });

            // PIN Code TextBox
            $("#pinCodeTextBox").dxTextBox({
                placeholder: "4 أرقام",
                mask: "0000",
                stylingMode: "outlined",
                showClearButton: true,
                onValueChanged: function(e) {
                    pinCode = e.value;
                }
            });

            // Is Admin Checkbox
            $("#isAdminCheckbox").dxCheckBox({
                text: "مسؤول نظام",
                value: false,
                onValueChanged: function(e) {
                    isAdmin = e.value;
                }
            });

            // Register Button
            $("#registerButton").dxButton({
                text: "إنشاء الحساب",
                type: "success",
                stylingMode: "contained",
                width: "100%",
                onClick: function(e) {
                    register();
                }
            });

            // Validation Group
            DevExpress.validationEngine.registerGroupForValidation("registerForm");
        }

        // Global variables
        let email = "";
        let userName = "";
        let password = "";
        let confirmPassword = "";
        let phoneNumber = "";
        let employeeId = null;
        let pinCode = "";
        let isAdmin = false;

        function updatePasswordStrength(password) {
            const strengthBar = $("#passwordStrengthBar").dxProgressBar("instance");
            let strength = 0;

            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;

            const percentage = (strength / 4) * 100;
            strengthBar.option("value", percentage);

            if (strength <= 1) {
                strengthBar.option("status", "low");
            } else if (strength === 2) {
                strengthBar.option("status", "medium");
            } else {
                strengthBar.option("status", "high");
            }
        }

        function validateEmail() {
            const emailInstance = $("#emailTextBox").dxTextBox("instance");
            const validator = emailInstance.dxValidator("instance");
            validator.validate();
        }

        function validatePasswordMatch() {
            const confirmInstance = $("#confirmPasswordTextBox").dxTextBox("instance");
            const validator = confirmInstance.dxValidator("instance");
            validator.validate();
        }

        async function register() {
            // Get all values
            const emailInstance = $("#emailTextBox").dxTextBox("instance");
            const userNameInstance = $("#userNameTextBox").dxTextBox("instance");
            const passwordInstance = $("#passwordTextBox").dxTextBox("instance");
            const confirmInstance = $("#confirmPasswordTextBox").dxTextBox("instance");
            const phoneInstance = $("#phoneNumberTextBox").dxTextBox("instance");
            const employeeInstance = $("#employeeIdNumberBox").dxNumberBox("instance");
            const pinInstance = $("#pinCodeTextBox").dxTextBox("instance");
            const adminInstance = $("#isAdminCheckbox").dxCheckBox("instance");

            email = emailInstance.option("value");
            userName = userNameInstance.option("value") || email;
            password = passwordInstance.option("value");
            confirmPassword = confirmInstance.option("value");
            phoneNumber = phoneInstance.option("value");
            employeeId = employeeInstance.option("value");
            pinCode = pinInstance.option("value");
            isAdmin = adminInstance.option("value");

            // Validate form
            const validationResult = DevExpress.validationEngine.validateGroup("registerForm");
            if (!validationResult.isValid) {
                DevExpress.ui.notify("الرجاء تصحيح الأخطاء في النموذج", "error", 3000);
                return;
            }

            // Additional validation
            if (pinCode && pinCode.length !== 4) {
                DevExpress.ui.notify('رمز PIN يجب أن يكون 4 أرقام', 'error', 3000);
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        userName: userName,
                        password: password,
                        confirmPassword: confirmPassword,
                        phoneNumber: phoneNumber,
                        employeeId: employeeId,
                        pinCode: pinCode,
                        isAdmin: isAdmin
                    })
                });

                const result = await response.json();

                if (response.ok && result.succeeded) {
                    DevExpress.ui.notify('تم إنشاء الحساب بنجاح! جاري التوجيه لتسجيل الدخول...', 'success', 3000);
                    setTimeout(() => {
                        window.location.href = '/Auth/LoginDX';
                    }, 2000);
                } else {
                    const errorMessage = result.errors && result.errors.length > 0 
                        ? result.errors.join(', ') 
                        : result.message || 'فشل إنشاء الحساب';
                    DevExpress.ui.notify(errorMessage, 'error', 3000);
                }
            } catch (error) {
                console.error('Registration error:', error);
                DevExpress.ui.notify('حدث خطأ أثناء إنشاء الحساب', 'error', 3000);
            }
        }
    </script>
</body>
</html>
