@model dynamic

@{
    ViewData["Title"] = "كشف حركة الصنف";
}

<div style="text-align: center; margin-bottom: 20px;">
    <h1 style="color: #2c3e50;">كشف حركة الصنف</h1>
</div>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle"></i> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <div class="col-md-12">
        <div style="background-color: #d1ecf1; border: 3px solid #17a2b8; padding: 20px; margin: 10px;">
            <div class="row">
                <div class="col-md-3">
                    <label style="margin-bottom: 10px;">اختر الصنف</label>
                    <select class="form-select" id="itemId" name="itemId" required style="font-size: 16px;">
                        <option value="">--اختر الصنف--</option>
                        @foreach (var item in Model.Items)
                        {
                            <option value="@item.ItemId">@item.ItemCode - @item.ItemName</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label style="margin-bottom: 10px;">اختر المخزن</label>
                    <select class="form-select" id="branchId" name="branchId" required style="font-size: 16px;">
                        <option value="">--اختر المخزن--</option>
                        @foreach (var branch in Model.Branches)
                        {
                            <option value="@branch.BranchId">@branch.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label style="margin-bottom: 10px;">من تاريخ</label>
                    <input type="date" class="form-control" id="fromDate" name="fromDate" required style="font-size: 16px;">
                </div>

                <div class="col-md-2">
                    <label style="margin-bottom: 10px;">إلى تاريخ</label>
                    <input type="date" class="form-control" id="toDate" name="toDate" required style="font-size: 16px;">
                </div>

                <div class="col-md-2">
                    <label style="margin-bottom: 10px;">&nbsp;</label>
                    <button type="button" class="btn btn-primary form-control" id="loadBtn" style="font-size: 16px;">
                        <i class="fas fa-search"></i> عرض
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div id="transactionsTable" style="display: none;">
            <table class="table table-striped table-bordered" id="transactionsDataTable">
                <thead class="table-dark">
                    <tr>
                        <th>التاريخ</th>
                        <th>نوع الحركة</th>
                        <th>الكمية الواردة</th>
                        <th>الكمية الصادرة</th>
                        <th>الرصيد</th>
                        <th>سعر الوحدة</th>
                        <th>القيمة</th>
                    </tr>
                </thead>
                <tbody id="transactionsBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#loadBtn').click(function () {
                var itemId = $('#itemId').val();
                var branchId = $('#branchId').val();
                var fromDate = $('#fromDate').val();
                var toDate = $('#toDate').val();

                if (!itemId || !branchId || !fromDate || !toDate) {
                    alert('يرجى ملء جميع الحقول');
                    return;
                }

                $.ajax({
                    url: '/ItemSheet/GetTransactions',
                    type: 'GET',
                    data: {
                        itemId: itemId,
                        branchId: branchId,
                        fromDate: fromDate,
                        toDate: toDate
                    },
                    success: function (response) {
                        if (response.success) {
                            displayTransactions(response.data);
                        } else {
                            alert('خطأ: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('حدث خطأ في تحميل البيانات');
                    }
                });
            });

            function displayTransactions(transactions) {
                var tbody = $('#transactionsBody');
                tbody.empty();

                if (transactions.length === 0) {
                    tbody.append('<tr><td colspan="7" class="text-center">لا توجد حركات</td></tr>');
                } else {
                    transactions.forEach(function (transaction) {
                        var row = '<tr>' +
                            '<td>' + new Date(transaction.Date).toLocaleDateString('ar-EG') + '</td>' +
                            '<td>' + transaction.MovementType + '</td>' +
                            '<td>' + (transaction.QtyIn || 0) + '</td>' +
                            '<td>' + (transaction.QtyOut || 0) + '</td>' +
                            '<td>' + transaction.Balance + '</td>' +
                            '<td>' + transaction.UnitPrice + '</td>' +
                            '<td>' + transaction.Value + '</td>' +
                            '</tr>';
                        tbody.append(row);
                    });
                }

                $('#transactionsTable').show();
            }
        });
    </script>
}