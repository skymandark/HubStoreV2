@model Core.ViewModels.TransferOrderViewModels.TransferOrderRequestDto
@{
    ViewData["Title"] = Model.TransferOrderId > 0 ? "تعديل طلب نقل" : "إنشاء طلب نقل جديد";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isEdit = Model.TransferOrderId > 0;
}

<style>
    :root {
        --primary-solid: #1e293b; /* Slate 800 */
        --accent-solid: #4f46e5; /* Indigo 600 */
        --accent-hover: #4338ca;
        --bg-app: #f1f5f9;
        --border-color: #cbd5e1;
        --success-solid: #10b981;
    }

    .premium-wrapper {
        background-color: var(--bg-app);
        min-height: 100vh;
        padding: 2rem;
    }

    .card-premium {
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .card-header-solid {
        background-color: var(--primary-solid);
        color: white;
        padding: 2rem 2.5rem;
    }

    .card-header-solid h2 { font-weight: 800; letter-spacing: -0.025em; }

    .grid-section-title {
        color: var(--primary-solid);
        font-weight: 700;
        border-left: 4px solid var(--accent-solid);
        padding-left: 1rem;
        margin-bottom: 1.5rem;
    }

    .btn-premium-save {
        background-color: var(--accent-solid);
        border: none;
        padding: 0.8rem 2.5rem;
        border-radius: 8px;
        font-weight: 700;
        transition: all 0.2s;
    }

    .btn-premium-save:hover {
        background-color: var(--accent-hover);
        transform: translateY(-2px);
    }

    .dx-datagrid-headers {
        background-color: #f8fafc !important;
        color: var(--primary-solid) !important;
        font-weight: 700 !important;
    }
</style>

<div class="premium-wrapper">
    <div class="card card-premium">
        <div class="card-header-solid d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1"><i class="fas fa-random me-3"></i> طلب نقل بضاعة</h2>
                <p class="mb-0 text-slate-400 opacity-75">إدارة عمليات تحويل المخزون بين فروع الشركة</p>
            </div>
            <div class="d-flex gap-3">
                <a href="@Url.Action("Index")" class="btn btn-outline-light px-4 rounded-pill">إلغاء</a>
                <button type="button" class="btn btn-premium-save text-white shadow" onclick="submitForm()">
                    <i class="fas fa-check-circle me-2"></i> حفظ الطلب
                </button>
            </div>
        </div>

        <div class="card-body p-4 p-lg-5 bg-white">
            <form id="transferForm" asp-action="@(Model.TransferOrderId > 0 ? "Update" : "Create")" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="TransferOrderId" />

                <div class="mb-5">
                    <h5 class="grid-section-title">المعلومات الأساسية للمستند</h5>
                    <div id="headerForm"></div>
                </div>

                <div class="mt-5">
                    <h5 class="grid-section-title">تفاصيل الأصناف المحولة</h5>
                    <div class="rounded-3 border overflow-hidden">
                        <div id="itemsGrid"></div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            const branches = @Html.Raw(Json.Serialize(Model.Branches));
            const shipmentTypes = @Html.Raw(Json.Serialize(Model.ShipmentTypes));
            const initialDetails = @Html.Raw(Json.Serialize(Model.SelectedItems ?? new List<Core.ViewModels.TransferOrderViewModels.SelectedItemDto>()));
            const availableItems = @Html.Raw(Json.Serialize(Model.AvailableItems));

            var headerForm = $("#headerForm").dxForm({
                formData: @Html.Raw(Json.Serialize(Model)),
                rtlEnabled: true,
                colCount: 3,
                labelMode: "floating",
                items: [
                    { dataField: "FromBranchId", label: { text: "من فرع (المصدر)" }, editorType: "dxSelectBox",
                      editorOptions: { dataSource: branches, valueExpr: "branchId", displayExpr: "name", onValueChanged: refreshGridItems },
                      validationRules: [{ type: "required" }] },
                    { dataField: "ToBranchId", label: { text: "إلى فرع (الوجهة)" }, editorType: "dxSelectBox",
                      editorOptions: { dataSource: branches, valueExpr: "branchId", displayExpr: "name" },
                      validationRules: [{ type: "required" }, { type: "custom", validationCallback: validateBranches, message: "لا يمكن النقل لنفس الفرع" }] },
                    { dataField: "DocDate", label: { text: "تاريخ الطلب" }, editorType: "dxDateBox", validationRules: [{ type: "required" }] },
                    { dataField: "ShipmentTypeId", label: { text: "طريقة الشحن" }, editorType: "dxSelectBox",
                      editorOptions: { dataSource: shipmentTypes, valueExpr: "shipmentTypeId", displayExpr: "name" } },
                    { dataField: "Reference", label: { text: "رقم المرجع" } },
                    { dataField: "Remarks", label: { text: "ملاحظات إضافية" }, editorType: "dxTextArea", colSpan: 3, editorOptions: { height: 80 } }
                ]
            }).dxForm("instance");

            var grid = $("#itemsGrid").dxDataGrid({
                dataSource: initialDetails,
                rtlEnabled: true,
                showBorders: false,
                rowAlternationEnabled: true,
                editing: {
                    mode: "cell",
                    allowUpdating: true,
                    allowAdding: true,
                    allowDeleting: true,
                    newRowPosition: "last",
                    useIcons: true
                },
                columns: [
                    { dataField: "itemId", caption: "الصنف", validationRules: [{ type: "required" }],
                      lookup: { dataSource: availableItems, valueExpr: "itemId", displayExpr: "itemNameEng" }, width: "40%" },
                    { dataField: "availableStock", caption: "الرصيد المتاح", dataType: "number", allowEditing: false, 
                      cssClass: "text-muted fw-bold", width: "20%", alignment: "center" },
                    { dataField: "quantity", caption: "الكمية المطلوبة", dataType: "number", validationRules: [{ type: "required" }], alignment: "center" }
                ],
                onCellValueChanged: function(e) {
                    if (e.column.dataField === "itemId" || e.column.dataField === "quantity") {
                        const fromBranchId = headerForm.getEditor("FromBranchId").option("value");
                        if (e.data.itemId && fromBranchId) {
                            $.post("@Url.Action("GetItemBalance")", { itemId: e.data.itemId, branchId: fromBranchId }, function(res) {
                                e.component.cellValue(e.row.rowIndex, "availableStock", res.balance);
                                if (e.data.quantity > res.balance) {
                                    DevExpress.ui.notify("تنبيه: الكمية المطلوبة تتجاوز الرصيد المتاح (" + res.balance + ")", "warning", 4000);
                                }
                            });
                        }
                    }
                },
                toolbar: {
                    items: [{
                        location: "before",
                        widget: "dxButton",
                        options: { text: "إضافة صنف للطلب", icon: "add", type: "default", stylingMode: "contained", onClick: function() { grid.addRow(); } }
                    }]
                }
            }).dxDataGrid("instance");

            function validateBranches(e) {
                return e.value !== headerForm.getEditor("FromBranchId").option("value");
            }

            function refreshGridItems() {
                // Future logic: filter available items based on fromBranch stock
                grid.refresh();
            }

            window.submitForm = function() {
                if (!headerForm.validate().isValid) {
                    DevExpress.ui.notify("يرجى إكمال البيانات الأساسية", "error", 3000);
                    return;
                }

                var itemsData = grid.option("dataSource");
                if (!itemsData || itemsData.length === 0) {
                    DevExpress.ui.notify("يجب إضافة صنف واحد على الأقل للطلب", "error", 3000);
                    return;
                }

                const form = $("#transferForm");
                
                // Append header data
                const formData = headerForm.option("formData");
                $.each(formData, function(key, value) {
                    if (value !== null && value !== undefined) {
                        $('<input>').attr('type', 'hidden').attr('name', key).val(value).appendTo(form);
                    }
                });

                // Append grid items
                itemsData.forEach((item, index) => {
                    $('<input>').attr('type', 'hidden').attr('name', `SelectedItems[${index}].ItemId`).val(item.itemId).appendTo(form);
                    $('<input>').attr('type', 'hidden').attr('name', `SelectedItems[${index}].Quantity`).val(item.quantity).appendTo(form);
                    $('<input>').attr('type', 'hidden').attr('name', `SelectedItems[${index}].TempOrder`).val(index + 1).appendTo(form);
                });

                form.submit();
            };
        });
    </script>
}
